<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <!-- configured in rollup.config.js -->
        <link rel="stylesheet" href="./styles.css" />
        <style>
            /* use a style on #app so that it's applied in the extension but not when using the simulator */
            #app {
                height: 100vh;
            }
        </style>
    </head>

    <body class="antialiased">
        <div x-data x-show="false" class="preload">Devtools loading...</div>

        <div
            id="app"
            class="h-full"
            x-cloak
            x-data="{
                version: null,
                latest: null,
                components : [],
                showTools: false,
                showTimeout: 1500,
                activeTheme: 'dark-header',

                orientation: 'portrait',
                breakpoint: 640,
                split: null,

                themes: {
                    light: {
                        'text-header': 'text-alpine-400',
                        'bg-header': 'bg-white',
                        'bg-logo-dark': 'text-alpine-400',
                        'bg-logo-light': 'text-silver-600',
                    },

                    'dark-header': {
                        'text-header': 'text-white',
                        'bg-header': 'bg-alpine-400',
                        'bg-logo-dark': 'text-ice-500',
                        'bg-logo-light': 'text-silver-500',
                    },
                },

                get isLatest() {
                    if (!this.version || !this.latest) return null;
                    const requiredArray = this.latest.split('.').map(v => parseInt(v, 10));
                    const currentArray = this.version.split('.').map(v => parseInt(v, 10));
                    for (let i = 0; i < requiredArray.length; i++) {
                        if (!currentArray[i] || currentArray[i] < requiredArray[i]) {
                            return false;
                        }
                        if (currentArray[i] > requiredArray[i]) {
                            return true;
                        }
                    }
                    return true
                },

                get detected(){
                    if (!this.showTools) {
                        return 'Alpine.js tools loading'
                    }

                    return this.version ? `Alpine.js v${this.version} detected` : 'Alpine.js <v2.3.1 detected'
                },

                get openComponent () {
                    return this.components.filter(component => {
                        return component.isOpened
                    })[0] || {}
                },

                get theme(){
                    return this.themes[this.activeTheme]
                },

                updateOrientation () {
                    this.orientation = window.innerWidth > this.breakpoint? 'landscape' : 'portrait'
                },

                initSplitPanes () {
                    if(this.split){
                        this.split.destroy(true)
                        this.$refs.panes.style.gridTemplateColumns = null
                        this.$refs.panes.style.gridTemplateRows = null
                    }

                    let splitOptions = {
                            minSize: window.innerWidth > this.breakpoint? 250 : 150,
                            snapOffset: 0,
                        },
                        key = window.innerWidth > this.breakpoint? 'columnGutters' : 'rowGutters'

                    splitOptions[key] = [{
                        track: 1,
                        element: this.$refs.handle,
                    }]

                    this.$nextTick(() => {
                        this.split = window.Split(splitOptions)
                    })
                },

                initLayout () {
                    this.initSplitPanes()
                    this.updateOrientation()
                },
            }"
            x-init="() => {
                initLayout()

                $watch('components', () => {
                    if (!showTools && components.length > 0) {
                        fetchWithTimeout('https://registry.npmjs.com/alpinejs', { timeout: showTimeout })
                            .then((data) => {
                                latest = data['dist-tags'].latest;
                                showTools = true;
                            }).catch(error => {
                                console.error('Could not load Alpine.js version data from registry.npmjs.com');
                                // latest will be as defaulted in state.js
                                showTools = true
                            })
                    }
                })

                $watch('orientation', () => {
                    initSplitPanes()
                })
            }"
            @resize.window.debounce.100="initLayout"
        >
            <div class="bg-white flex flex-col relative h-full w-full mx-auto">
                <div
                    :class="{
                        'bg-gray-100': !showTools,
                        [theme['bg-header']]: showTools,
                    }"
                    class="flex py-2 pl-3 pr-4 text-base leading-9 tracking-tight font-bold text-white border-b border-gray-300 transition duration-700 transition-colors ease-in-out sm:leading-10"
                >
                    <div class="flex-1">
                        <div class="flex items-center">
                            <svg
                                class="w-10 h-10 mr-3"
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 460 460"
                                fill="currentColor"
                                stroke="none"
                            >
                                <!-- <rect class="text-gray-100" x="0" y="0" width="460" height="460"></rect> -->
                                <polygon
                                    :class="{
                                'text-gray-600': !showTools,
                                [theme['bg-logo-dark']]: showTools,
                            }"
                                    class="transform transition-colors duration-700"
                                    points="50,230 140,140 320,320 140,320"
                                />
                                <polygon
                                    :class="{
                                'text-gray-400': !showTools,
                                [theme['bg-logo-light']]: showTools,
                            }"
                                    class="transform transition-colors duration-700"
                                    points="320,140 410,230 320,320 230,230"
                                />
                            </svg>

                            <div
                                :class="{
                                    'animate-pulse-fast': !showTools,
                                    'bg-gray-300 bg-opacity-50 text-gray-600': !showTools,
                                    'bg-green-100 text-green-700': showTools && isLatest,
                                    'bg-orange-100 text-orange-700': showTools && !isLatest,
                                }"
                                data-testid="status-line"
                                class="flex items-center px-1 py-0.5 rounded text-xs font-medium leading-4 transition transition-colors duration-700 ease-in-out"
                                :title="isLatest? 'Latest Version' : `Latest Version: ${latest}`"
                            >
                                <svg
                                    :class="{
                                        'text-gray-400': !showTools ,
                                        'text-green-500': showTools && isLatest,
                                        'text-orange-500': showTools && !isLatest,
                                    }"
                                    class="mr-1.5 h-2 w-2 transition transition-colors duration-700 ease-in-out"
                                    fill="currentColor"
                                    viewBox="0 0 8 8"
                                >
                                    <circle cx="4" cy="4" r="3" />
                                </svg>
                                <a
                                    :class="isLatest ? 'pointer-events-none' : ''"
                                    :href="isLatest ? '#' : 'https://github.com/alpinejs/alpine/releases'"
                                    x-text="detected"
                                ></a>
                            </div>
                        </div>
                    </div>

                    <div
                        :class="{
                            'text-gray-400': !showTools,
                            [theme['text-header']]: showTools,
                        }"
                        class="flex items-center space-x-2 transition transition-colors duration-700"
                    >
                        <a
                            href="https://github.com/alpinejs/alpine"
                            target="_blank"
                            title="Alpine.js Docs"
                            class="hover:opacity-75"
                        >
                            <svg
                                class="w-6 h-6"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                        </a>
                        <a
                            href="https://github.com/alpine-collective/alpinejs-devtools"
                            target="_blank"
                            title="Alpine Collective GitHub"
                            class="hover:opacity-75"
                        >
                            <svg class="fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                <path
                                    d="M10 0a10 10 0 0 0-3.16 19.49c.5.1.68-.22.68-.48l-.01-1.7c-2.78.6-3.37-1.34-3.37-1.34-.46-1.16-1.11-1.47-1.11-1.47-.9-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.9 1.52 2.34 1.08 2.91.83.1-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.94 0-1.1.39-1.99 1.03-2.69a3.6 3.6 0 0 1 .1-2.64s.84-.27 2.75 1.02a9.58 9.58 0 0 1 5 0c1.91-1.3 2.75-1.02 2.75-1.02.55 1.37.2 2.4.1 2.64.64.7 1.03 1.6 1.03 2.69 0 3.84-2.34 4.68-4.57 4.93.36.31.68.92.68 1.85l-.01 2.75c0 .26.18.58.69.48A10 10 0 0 0 10 0"
                                ></path>
                            </svg>
                        </a>
                    </div>
                </div>

                <div
                    x-ref="panes"
                    :class="{
                        'opacity-75': !showTools,
                        'grid-cols-panes': orientation === 'landscape',
                        'grid-rows-panes': orientation === 'portrait',
                    }"
                    class="flex-1 h-full grid sm:flex-row overflow-hidden"
                >
                    <!-- Components -->
                    <div class="relative flex-1 flex flex-col max-h-full overflow-scroll">
                        <div
                            :class="{
                                'hidden': !showTools,
                            }"
                            class="absolute min-w-full min-h-full p-2"
                        >
                            <template x-for="(component, index) in components">
                                <a
                                    :class="{
                                        'text-white bg-alpine-300' : component.isOpened,
                                        'text-gray-600 hover:bg-blue-100' : !component.isOpened,
                                    }"
                                    class="block cursor-pointer rounded"
                                    :style="`padding-left: ${component.depth * 20}px; `"
                                    @mouseenter="alpineState.hoverOnComponent(component)"
                                    @mouseleave="alpineState.hoverLeftComponent(component)"
                                    @click=" alpineState.renderComponentData(component)"
                                    data-testid="component-container"
                                >
                                    <h5 class="flex items-center px-2 leading-7 font-mono whitespace-no-wrap">
                                        <span class="opacity-25">&lt;</span>
                                        <span
                                            data-testid="component-name"
                                            x-text="component.name"
                                            class="text-base"
                                        ></span>
                                        <span class="opacity-25">&gt;</span>
                                    </h5>
                                </a>
                            </template>
                        </div>
                    </div>

                    <!-- Split Pane Gutter -->
                    <div
                        x-ref="handle"
                        :class="{
                            '-mx-1 px-1 cursor-col-resize': orientation === 'landscape',
                            '-my-1 py-1 cursor-row-resize': orientation === 'portrait'
                        }"
                        class="relative group flex items-center justify-center z-50"
                    >
                        <span
                            :class="{
                                'w-px h-full': orientation === 'landscape',
                                'w-full h-px': orientation === 'portrait'
                            }"
                            class="absolute bg-gray-300"
                        ></span>

                        <div
                            :class="{
                                'w-3 h-8': orientation === 'landscape',
                                'w-8 h-3': orientation === 'portrait'
                            }"
                            class="flex items-center justify-center text-gray-400 border border-gray-300 bg-gray-200 rounded z-50 group-hover:text-blue-400 group-hover:border-blue-300 group-hover:bg-blue-200"
                        >
                            <span>
                                <svg
                                    :class="{
                                        'hidden': orientation === 'landscape'
                                    }"
                                    class="w-3 h-3"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                    xmlns="http://www.w3.org/2000/svg"
                                >
                                    <path
                                        d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z"
                                    ></path>
                                </svg>
                                <svg
                                    :class="{
                                        'hidden': orientation === 'portrait'
                                    }"
                                    class="w-3 h-3"
                                    fill="currentColor"
                                    viewBox="0 0 20 20"
                                    xmlns="http://www.w3.org/2000/svg"
                                >
                                    <path
                                        d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"
                                    ></path>
                                </svg>
                            </span>
                        </div>
                    </div>

                    <!-- Active Component/Data -->
                    <div class="flex-1 relative flex flex-col max-h-full overflow-scroll">
                        <template x-if="openComponent.name">
                            <div
                                class="sticky top-0 left-0 z-20 w-full flex items-center px-3 py-2 text-base font-mono text-gray-600 bg-gray-100"
                            >
                                <span class="opacity-25">&lt;</span>
                                <span x-text="openComponent.name"></span>
                                <span class="opacity-25">&gt;</span>
                            </div>
                        </template>

                        <template x-if="!openComponent.name">
                            <div
                                x-text="showTools? 'Select a component to view' : ''"
                                class="flex h-full w-full items-center justify-center p-4 text-gray-400 text-sm bg-gray-50"
                            ></div>
                        </template>

                        <div class="flex-1 px-3 py-2">
                            <template x-for="(singleComponent, componentIndex) in components">
                                <div x-show="singleComponent.isOpened" class="font-mono">
                                    <div class="leading-6 text-gray-300">x-data: {</div>

                                    <div>
                                        <template x-for="(singleData, index) in singleComponent.flattenedData">
                                            <div class="group flex items-center">
                                                <a
                                                    :style="`margin-left: ${singleData.depth}px; `"
                                                    @click="alpineState.toggleDataAttribute(singleData)"
                                                    class="block px-1 rounded hover:bg-blue-100"
                                                    :class="{
                                                        'cursor-pointer': singleData.hasArrow
                                                    }"
                                                    x-show="singleData.isOpened"
                                                >
                                                    <h5
                                                        data-testid="data-property"
                                                        class="flex items-center relative pl-3 leading-6 text-sm whitespace-no-wrap"
                                                    >
                                                        <div class="absolute left-0 h-full flex items-center">
                                                            <span
                                                                x-show="singleData.hasArrow"
                                                                class="arrow"
                                                                :data-testid="singleData.isArrowDown ? 'arrow-down' : 'arrow-right'"
                                                                :class="{
                                                                    'right': !singleData.isArrowDown,
                                                                    'down': singleData.isArrowDown
                                                                }"
                                                            ></span>
                                                        </div>

                                                        <span
                                                            style="color: #881391"
                                                            x-text="singleData.attributeName"
                                                            data-testid="data-property-name"
                                                        ></span>

                                                        <span class="text-black">:</span>

                                                        <div
                                                            data-testid="data-property-value-container"
                                                            class="text-black ml-1"
                                                            x-show="!singleData.inEditingMode"
                                                        >
                                                            <template x-if="singleData.dataType == 'string'">
                                                                &quot;<span
                                                                    class="text-red-700"
                                                                    x-text="singleData.attributeValue"
                                                                ></span
                                                                >&quot;
                                                            </template>

                                                            <template x-if="singleData.dataType == 'boolean'">
                                                                <span
                                                                    class="text-blue-700"
                                                                    x-text="singleData.attributeValue"
                                                                ></span>
                                                            </template>

                                                            <template
                                                                x-if="['string', 'boolean'].includes(singleData.dataType) === false"
                                                            >
                                                                <span x-text="singleData.attributeValue"></span>
                                                            </template>
                                                        </div>
                                                    </h5>
                                                </a>

                                                <div
                                                    class="flex flex-col"
                                                    x-show="!singleData.hasArrow
                                                    && !singleData.readOnly
                                                    && singleData.isOpened"
                                                >
                                                    <svg
                                                        fill="currentColor"
                                                        x-show="!singleData.inEditingMode
                                                        && singleData.dataType !== 'boolean'"
                                                        data-testid="edit-icon"
                                                        @click="alpineState.editAttribute(singleData)"
                                                        viewBox="0 0 20 20"
                                                        class="w-4 h-4 cursor-pointer opacity-0 group-hover:opacity-100 hover:opacity-75"
                                                    >
                                                        <path
                                                            d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"
                                                        ></path>
                                                    </svg>

                                                    <template x-if="singleData.dataType == 'boolean'">
                                                        <input
                                                            type="checkbox"
                                                            x-model="singleData.editAttributeValue"
                                                            @change.stop="$nextTick(() => alpineState.saveEditing(singleData))"
                                                            class="form-checkbox h-4 w-4 text-blue-700 transition duration-150 ease-in-out opacity-0 group-hover:opacity-100"
                                                        />
                                                    </template>

                                                    <template x-if="singleData.dataType !== 'boolean'">
                                                        <div
                                                            x-show="singleData.inEditingMode"
                                                            class="flex flex-row items-center"
                                                        >
                                                            <input
                                                                @keydown.enter.stop="alpineState.saveEditing(singleData)"
                                                                @keydown.escape.stop="alpineState.cancelEditing(singleData)"
                                                                class="flex text-gray-700 leading-tight focus:outline-none focus:shadow-outline w-2/3 shadow appearance-none border rounded py-1 px-1"
                                                                :type="singleData.dataType"
                                                                x-model="singleData.editAttributeValue"
                                                            />

                                                            <svg
                                                                fill="currentColor"
                                                                data-testid="save-icon"
                                                                @click="alpineState.saveEditing(singleData)"
                                                                viewBox="0 0 20 20"
                                                                class="flex w-5 h-5 cursor-pointer ml-2 hover:opacity-75"
                                                            >
                                                                <path
                                                                    fill-rule="evenodd"
                                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                                    clip-rule="evenodd"
                                                                ></path>
                                                            </svg>

                                                            <svg
                                                                fill="currentColor"
                                                                data-testid="cancel-icon"
                                                                @click="alpineState.cancelEditing(singleData)"
                                                                viewBox="0 0 20 20"
                                                                class="flex w-5 h-5 ml-1 cursor-pointer hover:opacity-75"
                                                            >
                                                                <path
                                                                    fill-rule="evenodd"
                                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                                                    clip-rule="evenodd"
                                                                ></path>
                                                            </svg>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>

                                    <div class="leading-7 text-gray-300">}</div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="./panel.js"></script>
    </body>
</html>
